const { expect } = require("chai")
const hre = require("hardhat")
const { getStorageAt } = require("@nomicfoundation/hardhat-network-helpers");

describe("Good", function () {
  it("Should change the helper address of the Good Contract", async function () {
    const helperContract = await hre.ethers.deployContract("Helper", [])
    await helperContract.waitForDeployment()

    const goodContract = await hre.ethers.deployContract("Good", [helperContract.target])
    await goodContract.waitForDeployment()

    // Get Memory Slot in position 0 and "helper" value inside Good contract before setNum call
    let slot = await getStorageAt(goodContract.target, 0)
    slot = hre.ethers.AbiCoder.defaultAbiCoder().decode(["address"], slot)[0]
    const beforeValue = await goodContract.helper()
    expect(beforeValue).to.equal(helperContract.target)
    expect(slot).to.equal(helperContract.target)

    // Update Num with delegateCall
    await goodContract.setNum(5)

    // Get Memory Slot in position 0 and "helper" value inside Good contract after setNum call
    slot = await getStorageAt(goodContract.target, 0)
    slot = hre.ethers.AbiCoder.defaultAbiCoder().decode(["uint"], slot)[0]
    const afterValue = await goodContract.helper()
    expect(parseInt(afterValue)).to.equal(5)
    expect(parseInt(slot)).to.equal(5)
  })
})
